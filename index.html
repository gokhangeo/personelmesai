<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mersin Kadastro - ƒ∞zin Takip Sistemi</title>
    <!-- SheetJS (Excel okuma/yazma) k√ºt√ºphanesi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --background-color: #f8f9fa;
            --font-color: #212529;
            --border-color: #dee2e6;
            --today-bg: #e6f2ff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--font-color);
            padding: 15px;
        }
        
        /* Gƒ∞Rƒ∞≈û EKRANI */
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: var(--primary-color);
            margin: -15px;
        }
        #login-box {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            text-align: center;
            width: 300px;
        }
        #login-box h2 { color: var(--primary-color); margin-top: 0; }
        #password-input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
        }
        #login-button {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #login-button:hover { background-color: #0056b3; }
        #login-status { color: var(--danger-color); margin-top: 10px; min-height: 1.2em; }

        /* ANA UYGULAMA */
        .app-content { display: none; }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        /* HEADER & NAVIGATION */
        .app-header {
            background-color: #343a40;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-title { font-size: 1.2rem; font-weight: bold; }
        .action-buttons { display: flex; gap: 10px; }
        .btn-download-plan {
            background-color: var(--info-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .btn-download-plan:hover { background-color: #138496; }

        /* TAKVƒ∞M */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: var(--primary-color);
            color: white;
        }
        .calendar-header button {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }
        .calendar-header button:hover { background-color: rgba(255,255,255,0.2); }
        #current-month-year { font-size: 1.5rem; font-weight: bold; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .day-header, .day-cell {
            padding: 10px;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        .day-header { font-weight: bold; text-align: center; background-color: #f1f1f1; }
        .day-cell {
            min-height: 120px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        .day-cell:hover { background-color: #f5f5f5; }
        .day-number { font-weight: bold; margin-bottom: 5px; }
        .day-cell.other-month { color: #ccc; background-color: #fafafa; }
        .day-cell.today { background-color: var(--today-bg); }
        
        /* ƒ∞Zƒ∞N ETƒ∞KETLERƒ∞ */
        .izin-entry {
            font-size: 0.75rem;
            padding: 3px 5px;
            margin-top: 3px;
            border-radius: 3px;
            color: #333;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .izin-entry:hover { opacity: 0.9; }
        
        /* ƒ∞zin T√ºr√ºne G√∂re Renkler */
        .type-gunluk { background-color: var(--warning-color); } /* Sarƒ± */
        .type-saatlik { background-color: #ffdab9; } /* A√ßƒ±k Turuncu */
        .type-yillik { background-color: var(--success-color); color: white; } /* Ye≈üil */

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%; max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer; color: #aaa;
        }
        
        /* Form Elemanlarƒ± */
        #izin-form { display: flex; flex-direction: column; gap: 15px; }
        label { font-weight: 600; margin-bottom: 5px; display: block; }
        select, input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        
        .radio-group { display: flex; gap: 15px; margin-bottom: 5px; }
        .radio-group label { font-weight: normal; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .radio-group input { width: auto; }

        .date-range-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .form-buttons { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 10px; }
        #save-button { background-color: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; }
        #delete-button { background-color: var(--danger-color); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; display: none; }
        
        /* RAPOR ALANI */
        .summary-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border-bottom: 2px solid var(--border-color);
        }
        .summary-header h3 { margin: 0; color: var(--primary-color); }
        .report-buttons button {
            background-color: var(--success-color); color: white;
            border: none; padding: 8px 12px; border-radius: 5px;
            cursor: pointer; margin-left: 5px;
        }
        .report-buttons button:hover { background-color: #218838; }

        /* Alan Gizleme/G√∂sterme */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- Gƒ∞Rƒ∞≈û EKRANI -->
<div id="login-screen">
    <div id="login-box">
        <h2>Mersin Kadastro<br>ƒ∞zin Takip Sistemi</h2>
        <form id="login-form">
            <input type="password" id="password-input" placeholder="≈ûifre: 2203" required>
            <button type="submit" id="login-button">Giri≈ü Yap</button>
            <div id="login-status"></div>
        </form>
    </div>
</div>

<!-- ANA UYGULAMA (Gizli) -->
<div id="main-app-wrapper" class="app-content">
    
    <!-- √úst Bar: Yƒ±llƒ±k ƒ∞zin √áizelgesi ƒ∞ndirme -->
    <div class="container app-header">
        <div class="app-title">Personel ƒ∞zin Y√∂netimi</div>
        <div class="action-buttons">
            <button id="btn-download-blank-plan" class="btn-download-plan">
                üìÑ 2026 Bo≈ü Yƒ±llƒ±k ƒ∞zin √áizelgesi ƒ∞ndir
            </button>
        </div>
    </div>

    <!-- Takvim Alanƒ± -->
    <div class="container">
        <div class="calendar-header">
            <button id="prev-month">‚ùÆ √ñnceki Ay</button>
            <h2 id="current-month-year"></h2>
            <button id="next-month">Sonraki Ay ‚ùØ</button>
        </div>
        <div class="calendar-grid day-headers">
            <div class="day-header">Pzt</div>
            <div class="day-header">Sal</div>
            <div class="day-header">√áar</div>
            <div class="day-header">Per</div>
            <div class="day-header">Cum</div>
            <div class="day-header">Cmt</div>
            <div class="day-header">Paz</div>
        </div>
        <div class="calendar-grid" id="calendar-body">
            <!-- Takvim JS ile dolacak -->
        </div>
    </div>

    <!-- Aylƒ±k √ñzet ve Raporlar -->
    <div class="container">
        <div class="summary-header">
            <h3>Ayƒ±n ƒ∞zin √ñzeti</h3>
            <div class="report-buttons">
                <button id="export-monthly-report">Aylƒ±k Rapor (Excel)</button>
                <button id="export-yearly-report">Yƒ±llƒ±k Rapor (Excel)</button>
            </div>
        </div>
        <div id="monthly-summary" style="padding: 20px;"></div>
    </div>
</div>

<!-- ƒ∞zin Ekleme/D√ºzenleme Modalƒ± -->
<div id="izin-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3 id="modal-title">ƒ∞zin Giri≈üi</h3>
        <form id="izin-form">
            <input type="hidden" id="izin-id">
            
            <!-- Personel Se√ßimi -->
            <div>
                <label for="personel-listesi">Personel:</label>
                <select id="personel-listesi" required>
                    <option value="">Y√ºkleniyor...</option>
                </select>
            </div>

            <!-- ƒ∞zin T√ºr√º Se√ßimi -->
            <div>
                <label>ƒ∞zin T√ºr√º:</label>
                <div class="radio-group">
                    <label><input type="radio" name="izinTuru" value="G√ºnl√ºk" checked> G√ºnl√ºk</label>
                    <label><input type="radio" name="izinTuru" value="Saatlik"> Saatlik</label>
                    <label><input type="radio" name="izinTuru" value="Yƒ±llƒ±k ƒ∞zin"> Yƒ±llƒ±k ƒ∞zin (2026)</label>
                </div>
            </div>

            <!-- Tarih Alanlarƒ± -->
            <div id="tek-tarih-wrapper">
                <label for="izin-tarihi">ƒ∞zin Tarihi:</label>
                <input type="date" id="izin-tarihi">
            </div>

            <div id="tarih-araligi-wrapper" class="hidden">
                <label>Yƒ±llƒ±k ƒ∞zin Tarih Aralƒ±ƒüƒ±:</label>
                <div class="date-range-group">
                    <div>
                        <small>Ba≈ülangƒ±√ß</small>
                        <input type="date" id="baslangic-tarihi">
                    </div>
                    <div>
                        <small>Biti≈ü (Dahil)</small>
                        <input type="date" id="bitis-tarihi">
                    </div>
                </div>
            </div>

            <!-- Saatlik Alanƒ± -->
            <div id="saatlik-alan" class="hidden">
                <label>Saat Aralƒ±ƒüƒ±:</label>
                <div class="date-range-group">
                    <input type="time" id="baslangic-saati">
                    <input type="time" id="bitis-saati">
                </div>
            </div>

            <!-- Neden -->
            <div>
                <label for="izin-nedeni">A√ßƒ±klama / Neden (Opsiyonel):</label>
                <input type="text" id="izin-nedeni" placeholder="√ñrn: Yƒ±llƒ±k ƒ∞zin 1. Par√ßa">
            </div>

            <!-- Butonlar -->
            <div class="form-buttons">
                 <button type="submit" id="save-button">Kaydet</button>
                 <button type="button" id="delete-button">Sil</button>
            </div>
            <div id="status"></div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- SABƒ∞TLER VE AYARLAR ---
    const CORRECT_PASSWORD = '2203';
    const GITHUB_OWNER = 'gokhangeo';
    const GITHUB_REPO = 'personelmesai';
    const KAYIT_DOSYASI_YOLU = 'izinler.json';
    const PERSONEL_EXCEL_URL = 'https://raw.githubusercontent.com/gokhangeo/personelmesai/main/PERSONEL.xlsx';
    
    // API Token (Par√ßalƒ±)
    const tokenParts = ['ghp_2KS6iY', '7t1ka6bKyHw', 'ONJkXdwOU', 'VhrU3PqlSX'];
    const GITHUB_TOKEN = tokenParts.join('');

    // --- DOM ELEMENTLERƒ∞ ---
    const loginScreen = document.getElementById('login-screen');
    const mainAppWrapper = document.getElementById('main-app-wrapper');
    const calendarBody = document.getElementById('calendar-body');
    const currentMonthYearEl = document.getElementById('current-month-year');
    const modal = document.getElementById('izin-modal');
    const modalTitle = document.getElementById('modal-title');
    const izinForm = document.getElementById('izin-form');
    const personelSelect = document.getElementById('personel-listesi');
    const statusDiv = document.getElementById('status');
    const deleteButton = document.getElementById('delete-button');
    const saveButton = document.getElementById('save-button');
    
    // Form Alanlarƒ±
    const radioButtons = document.querySelectorAll('input[name="izinTuru"]');
    const tekTarihWrapper = document.getElementById('tek-tarih-wrapper');
    const tarihAraligiWrapper = document.getElementById('tarih-araligi-wrapper');
    const saatlikAlan = document.getElementById('saatlik-alan');
    
    // --- STATE (DURUM) ---
    let currentDate = new Date();
    let izinKayitlari = [];
    let personelListesi = [];

    // ==========================================
    // 1. Gƒ∞Rƒ∞≈û ƒ∞≈ûLEMLERƒ∞
    // ==========================================
    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        if (document.getElementById('password-input').value === CORRECT_PASSWORD) {
            loginScreen.style.display = 'none';
            mainAppWrapper.style.display = 'block';
            initializeApp();
        } else {
            document.getElementById('login-status').textContent = 'Hatalƒ± ≈üifre!';
        }
    });

    // ==========================================
    // 2. YILLIK ƒ∞Zƒ∞N √áƒ∞ZELGESƒ∞ OLU≈ûTURUCU (EXCEL)
    // ==========================================
    document.getElementById('btn-download-blank-plan').addEventListener('click', () => {
        const wb = XLSX.utils.book_new();
        
        // Ba≈ülƒ±klar
        const ws_data = [
            ["MERSƒ∞N KADASTRO M√úD√úRL√úƒû√ú 2026 YILI YILLIK ƒ∞Zƒ∞N PLANLAMA √áƒ∞ZELGESƒ∞"],
            ["Personel Adƒ± Soyadƒ±:", "__________________________"],
            ["√únvanƒ±:", "__________________________"],
            [], // Bo≈ü satƒ±r
            ["AY", "G√úNLER (Planlanan izin tarihlerini i≈üaretleyiniz)"]
        ];

        // 2026 Yƒ±lƒ± Aylarƒ±
        const aylar = ["Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran", "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"];
        
        aylar.forEach(ay => {
            // Basit bir ƒ±zgara g√∂r√ºn√ºm√º: Ay Adƒ± | 1 2 3 ... 31
            let row = [ay]; 
            for(let i=1; i<=31; i++) {
                row.push(i);
            }
            ws_data.push(row);
        });

        ws_data.push([], ["Onay:", "........................................"]);

        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        
        // S√ºtun geni≈ülikleri (G√∂rsellik i√ßin)
        const wscols = [{wch:15}]; // ƒ∞lk s√ºtun geni≈ü
        for(let i=0; i<31; i++) wscols.push({wch:3}); // G√ºn s√ºtunlarƒ± dar
        ws['!cols'] = wscols;

        // H√ºcre birle≈ütirme (Ba≈ülƒ±k i√ßin)
        ws['!merges'] = [{ s: {r:0, c:0}, e: {r:0, c:10} }]; 

        XLSX.utils.book_append_sheet(wb, ws, "2026_Planlama");
        XLSX.writeFile(wb, "Mersin_Kadastro_2026_Yillik_Izin_Cizelgesi.xlsx");
    });

    // ==========================================
    // 3. API & VERƒ∞ ƒ∞≈ûLEMLERƒ∞
    // ==========================================
    const githubApiCall = async (url, options = {}) => {
        options.headers = {
            'Authorization': `Bearer ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json',
            ...options.headers
        };
        return fetch(url, options);
    };

    const initializeApp = async () => {
        await personelleriYukle();
        await izinleriYukle();
        renderCalendar();
    };

    const personelleriYukle = async () => {
        try {
            personelSelect.innerHTML = '<option value="">Y√ºkleniyor...</option>';
            const response = await fetch(PERSONEL_EXCEL_URL);
            if (!response.ok) throw new Error('Personel listesi alƒ±namadƒ±');
            const ab = await response.arrayBuffer();
            const wb = XLSX.read(ab, { type: 'buffer' });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            personelListesi = data.map(p => p['Adƒ± Soyadƒ±']).filter(Boolean);
            
            personelSelect.innerHTML = '<option value="">Personel Se√ßiniz</option>';
            personelListesi.forEach(ad => {
                personelSelect.add(new Option(ad, ad));
            });
        } catch (error) {
            console.error(error);
            personelSelect.innerHTML = '<option value="">Hata!</option>';
        }
    };

    const izinleriYukle = async () => {
        try {
            const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${KAYIT_DOSYASI_YOLU}`;
            const res = await githubApiCall(url);
            if (res.status === 404) { izinKayitlari = []; return; }
            const data = await res.json();
            // UTF-8 Decode
            const content = decodeURIComponent(escape(window.atob(data.content)));
            izinKayitlari = JSON.parse(content);
        } catch (error) {
            console.error('ƒ∞zin y√ºkleme hatasƒ±:', error);
            izinKayitlari = [];
        }
    };

    const izinleriKaydet = async (mesaj) => {
        try {
            const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${KAYIT_DOSYASI_YOLU}`;
            
            // Mevcut SHA'yƒ± al
            let sha = null;
            const checkRes = await githubApiCall(url);
            if (checkRes.ok) {
                const data = await checkRes.json();
                sha = data.sha;
            }

            // UTF-8 Encode
            const content = window.btoa(unescape(encodeURIComponent(JSON.stringify(izinKayitlari, null, 2))));

            const res = await githubApiCall(url, {
                method: 'PUT',
                body: JSON.stringify({ message: mesaj, content: content, sha: sha })
            });

            if (!res.ok) throw new Error('Kayƒ±t ba≈üarƒ±sƒ±z');
            return true;
        } catch (error) {
            statusDiv.textContent = 'Hata: ' + error.message;
            statusDiv.className = 'error';
            return false;
        }
    };

    // ==========================================
    // 4. TAKVƒ∞M VE ARAY√úZ
    // ==========================================
    const renderCalendar = () => {
        calendarBody.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // Ay ba≈ülƒ±ƒüƒ±
        const ayIsimleri = ["Ocak","≈ûubat","Mart","Nisan","Mayƒ±s","Haziran","Temmuz","Aƒüustos","Eyl√ºl","Ekim","Kasƒ±m","Aralƒ±k"];
        currentMonthYearEl.textContent = `${ayIsimleri[month]} ${year}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        // Pazartesi'den ba≈ülatma (0=Pazartesi, 6=Pazar mantƒ±ƒüƒ±na √ßevir)
        let startDay = firstDay.getDay() - 1;
        if (startDay === -1) startDay = 6;

        // Bo≈ü kutular
        for(let i=0; i<startDay; i++) {
            const div = document.createElement('div');
            div.className = 'day-cell other-month';
            calendarBody.appendChild(div);
        }

        // G√ºnler
        for(let d=1; d<=lastDay.getDate(); d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            
            const today = new Date();
            if(d === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                cell.className += ' today';
            }

            // Tarih numarasƒ±
            const numDiv = document.createElement('div');
            numDiv.className = 'day-number';
            numDiv.textContent = d;
            cell.appendChild(numDiv);

            // ƒ∞zinleri Bul ve Ekle
            const gununIzinleri = izinKayitlari.filter(i => i.tarih === dateStr);
            gununIzinleri.forEach(izin => {
                const div = document.createElement('div');
                div.textContent = `${izin.adSoyad.split(' ')[0]} - ${izin.izinTuru === 'Saatlik' ? izin.saatAraligi : (izin.izinTuru === 'Yƒ±llƒ±k ƒ∞zin' ? 'Yƒ±llƒ±k' : 'G√ºnl√ºk')}`;
                div.title = izin.neden || '';
                
                // Renk Sƒ±nƒ±fƒ± Ekleme
                div.className = 'izin-entry';
                if (izin.izinTuru === 'Yƒ±llƒ±k ƒ∞zin') div.classList.add('type-yillik');
                else if (izin.izinTuru === 'Saatlik') div.classList.add('type-saatlik');
                else div.classList.add('type-gunluk');

                div.onclick = (e) => { e.stopPropagation(); openModal(dateStr, izin.id); };
                cell.appendChild(div);
            });

            // H√ºcreye tƒ±klama (Yeni ƒ∞zin)
            cell.onclick = () => openModal(dateStr);
            calendarBody.appendChild(cell);
        }
        
        renderSummary(year, month);
    };

    const renderSummary = (year, month) => {
        const div = document.getElementById('monthly-summary');
        div.innerHTML = '';
        
        const buAyinIzinleri = izinKayitlari.filter(i => {
            const d = new Date(i.tarih);
            return d.getFullYear() === year && d.getMonth() === month;
        }).sort((a,b) => new Date(a.tarih) - new Date(b.tarih));

        if(buAyinIzinleri.length === 0) {
            div.innerHTML = '<p style="text-align:center; color:#999">Bu ay kayƒ±tlƒ± izin yok.</p>';
            return;
        }

        const ul = document.createElement('ul');
        ul.style.listStyle = 'none';
        ul.style.padding = 0;

        buAyinIzinleri.forEach(izin => {
            const li = document.createElement('li');
            li.style.borderBottom = '1px solid #eee';
            li.style.padding = '8px 0';
            
            // Tarih formatla
            const tarihTr = new Date(izin.tarih).toLocaleDateString('tr-TR');
            
            let detay = '';
            if(izin.izinTuru === 'Yƒ±llƒ±k ƒ∞zin') detay = '<strong style="color:green">[Yƒ±llƒ±k ƒ∞zin]</strong>';
            else if(izin.izinTuru === 'Saatlik') detay = `<span style="color:orange">[Saatlik: ${izin.saatAraligi}]</span>`;
            else detay = '<span style="color:#d4a017">[G√ºnl√ºk]</span>';

            li.innerHTML = `<strong>${tarihTr}</strong> - <b>${izin.adSoyad}</b> ${detay} <br><small>${izin.neden || ''}</small>`;
            ul.appendChild(li);
        });
        div.appendChild(ul);
    };

    // ==========================================
    // 5. MODAL VE FORM ƒ∞≈ûLEMLERƒ∞
    // ==========================================
    const openModal = (dateStr, id = null) => {
        izinForm.reset();
        statusDiv.textContent = '';
        statusDiv.className = '';
        document.getElementById('izin-id').value = id || '';
        
        // Varsayƒ±lan g√∂r√ºn√ºm
        tekTarihWrapper.classList.remove('hidden');
        tarihAraligiWrapper.classList.add('hidden');
        saatlikAlan.classList.add('hidden');
        saveButton.textContent = 'Kaydet';
        deleteButton.style.display = id ? 'block' : 'none';

        if(id) {
            // D√ºzenleme Modu
            const rec = izinKayitlari.find(r => r.id == id);
            if(!rec) return;

            personelSelect.value = rec.adSoyad;
            document.querySelector(`input[name="izinTuru"][value="${rec.izinTuru}"]`).checked = true;
            document.getElementById('izin-nedeni').value = rec.neden || '';
            document.getElementById('izin-tarihi').value = rec.tarih; // D√ºzenlemede her zaman tek g√ºn √ºzerinden gidiyoruz basitlik i√ßin
            
            if(rec.izinTuru === 'Saatlik') {
                saatlikAlan.classList.remove('hidden');
                const [b, s] = (rec.saatAraligi || '-').split('-');
                document.getElementById('baslangic-saati').value = b ? b.trim() : '';
                document.getElementById('bitis-saati').value = s ? s.trim() : '';
            }
            // Not: Yƒ±llƒ±k izin d√ºzenlenirken de tekil g√ºn olarak a√ßƒ±lƒ±r, bu karma≈üƒ±klƒ±ƒüƒ± √∂nler.
            modalTitle.textContent = 'ƒ∞zin D√ºzenle';
        } else {
            // Yeni Kayƒ±t Modu
            document.getElementById('izin-tarihi').value = dateStr;
            document.getElementById('baslangic-tarihi').value = dateStr; // Yƒ±llƒ±k izin ba≈ülangƒ±cƒ± i√ßin varsayƒ±lan
            modalTitle.textContent = 'Yeni ƒ∞zin Giri≈üi';
        }
        
        updateFormView(); // Radyo buton durumuna g√∂re alanlarƒ± g√ºncelle
        modal.style.display = 'flex';
    };

    const updateFormView = () => {
        const tur = document.querySelector('input[name="izinTuru"]:checked').value;
        const id = document.getElementById('izin-id').value;

        // D√ºzenleme modunda tarih aralƒ±ƒüƒ± √∂zelliƒüini kapatƒ±yoruz karma≈üƒ±klƒ±ƒüƒ± √∂nlemek i√ßin
        if (id) {
            tarihAraligiWrapper.classList.add('hidden');
            tekTarihWrapper.classList.remove('hidden');
        } else {
            if (tur === 'Yƒ±llƒ±k ƒ∞zin') {
                tekTarihWrapper.classList.add('hidden');
                tarihAraligiWrapper.classList.remove('hidden');
            } else {
                tekTarihWrapper.classList.remove('hidden');
                tarihAraligiWrapper.classList.add('hidden');
            }
        }

        if (tur === 'Saatlik') {
            saatlikAlan.classList.remove('hidden');
        } else {
            saatlikAlan.classList.add('hidden');
        }
    };

    // Radyo butonu deƒüi≈üimlerini dinle
    radioButtons.forEach(rb => rb.addEventListener('change', updateFormView));

    // Kaydetme ƒ∞≈ülemi
    izinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        statusDiv.textContent = 'Kaydediliyor...';
        statusDiv.className = '';

        const id = document.getElementById('izin-id').value;
        const adSoyad = personelSelect.value;
        const izinTuru = document.querySelector('input[name="izinTuru"]:checked').value;
        const neden = document.getElementById('izin-nedeni').value;
        
        if (!adSoyad) { statusDiv.textContent = 'Personel se√ßiniz!'; return; }

        let yeniKayitlar = [];

        // Yƒ±llƒ±k ƒ∞zin (Toplu Giri≈ü) ve Yeni Kayƒ±t ise
        if (izinTuru === 'Yƒ±llƒ±k ƒ∞zin' && !id) {
            const baslangic = new Date(document.getElementById('baslangic-tarihi').value);
            const bitis = new Date(document.getElementById('bitis-tarihi').value);
            
            if (isNaN(baslangic) || isNaN(bitis) || baslangic > bitis) {
                statusDiv.textContent = 'Ge√ßerli bir tarih aralƒ±ƒüƒ± giriniz!';
                return;
            }

            // D√∂ng√º ile g√ºnleri ekle
            for (let d = new Date(baslangic); d <= bitis; d.setDate(d.getDate() + 1)) {
                yeniKayitlar.push({
                    id: Date.now() + Math.random(), // Benzersiz ID
                    adSoyad,
                    izinTuru,
                    tarih: d.toISOString().split('T')[0],
                    saatAraligi: '',
                    neden
                });
            }
        } else {
            // Tekil Giri≈ü (G√ºnl√ºk, Saatlik veya D√ºzenleme)
            const tarih = document.getElementById('izin-tarihi').value;
            let saatAraligi = '';
            
            if (izinTuru === 'Saatlik') {
                const s1 = document.getElementById('baslangic-saati').value;
                const s2 = document.getElementById('bitis-saati').value;
                if(!s1 || !s2) { statusDiv.textContent = 'Saatleri giriniz!'; return; }
                saatAraligi = `${s1} - ${s2}`;
            }

            yeniKayitlar.push({
                id: id ? parseFloat(id) : Date.now(),
                adSoyad,
                izinTuru,
                tarih,
                saatAraligi,
                neden
            });
        }

        // State G√ºncelleme
        if (id) {
            // D√ºzenleme: Eskiyi sil, yeniyi koy (Tekil)
            izinKayitlari = izinKayitlari.filter(k => k.id != id);
            izinKayitlari.push(yeniKayitlar[0]);
        } else {
            // Yeni Ekleme
            izinKayitlari.push(...yeniKayitlar);
        }

        const success = await izinleriKaydet(id ? `D√ºzenleme: ${adSoyad}` : `Yeni Kayƒ±t: ${adSoyad} (${yeniKayitlar.length} g√ºn)`);
        
        if (success) {
            statusDiv.textContent = 'Ba≈üarƒ±lƒ±!';
            statusDiv.className = 'success';
            renderCalendar();
            setTimeout(() => { modal.style.display = 'none'; }, 1000);
        }
    });

    // Silme ƒ∞≈ülemi
    deleteButton.addEventListener('click', async () => {
        const id = document.getElementById('izin-id').value;
        if (!confirm('Bu izni silmek istiyor musunuz?')) return;
        
        izinKayitlari = izinKayitlari.filter(k => k.id != id);
        const success = await izinleriKaydet('ƒ∞zin silindi');
        
        if(success) {
            modal.style.display = 'none';
            renderCalendar();
        }
    });

    // --- Modal Kapatma ---
    document.querySelector('.close-button').onclick = () => modal.style.display = 'none';
    window.onclick = (e) => { if(e.target == modal) modal.style.display = 'none'; };
    
    // --- Ay Deƒüi≈ütirme Butonlarƒ± ---
    document.getElementById('prev-month').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); };
    document.getElementById('next-month').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); };

    // --- RAPOR BUTONLARI ---
    const exportExcel = (data, name) => {
        if(!data.length) { alert('Veri yok'); return; }
        const ws = XLSX.utils.json_to_sheet(data.map(i => ({
            'Personel': i.adSoyad,
            'Tarih': i.tarih,
            'T√ºr': i.izinTuru,
            'Saat': i.saatAraligi,
            'Neden': i.neden
        })));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Rapor");
        XLSX.writeFile(wb, name + ".xlsx");
    };

    document.getElementById('export-monthly-report').onclick = () => {
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        const data = izinKayitlari.filter(i => { const d=new Date(i.tarih); return d.getFullYear()===y && d.getMonth()===m; });
        exportExcel(data, `Aylik_Rapor_${y}_${m+1}`);
    };
    
    document.getElementById('export-yearly-report').onclick = () => {
        const y = currentDate.getFullYear();
        const data = izinKayitlari.filter(i => new Date(i.tarih).getFullYear()===y);
        exportExcel(data, `Yillik_Rapor_${y}`);
    };
});
</script>
</body>
</html>
